# models/intermediate/oracle_lcdp/_oracle_lcdp__intermediate_models.yml
version: 2

models:
  - name: int_oracle_lcdp__telemetry_tasks
    description: >
      Table intermédiaire des tâches de télémétrie.
      Filtrée sur les tâches de type télémétrie (idtask_type=3)
      avec statut FAIT/VALIDE et label TELEM_SOURCE.

    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null

      - name: device_id
        description: "ID du device associé à la tâche"
        data_type: int64

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_id
        description: "ID du produit télémétrique"
        data_type: int64
        tests:
          - not_null

      - name: location_id
        description: "ID de la localisation de la tâche"
        data_type: int64

      - name: device_code
        description: "Code métier du device (numéro de série)"
        data_type: string

      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: company_code
        description: "Code client de l'entreprise"
        data_type: string

      - name: company_name
        description: "Nom de l'entreprise cliente"
        data_type: string

      - name: task_location_info
        description: "Informations d'accès de la localisation de la tâche"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de la tâche télémétrique"
        data_type: timestamp
        tests:
          - not_null

      - name: telemetry_quantity
        description: "Quantité télémétrique (toujours 1 par convention métier)"
        data_type: int64

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_lcdp__chargement_tasks
    description: >
      Table intermédiaire des tâches de chargement machine.
      Filtrée sur les tâches de type CHARGEMENT (idtask_type=13)
      avec statut FAIT/VALIDE/ANNULE et label du chargement (LOADING / REMOVING).

    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_id
        description: "ID du produit"
        data_type: int64
        tests:
          - not_null

      - name: roadman_id
        description: "ID du roadman associé à la tâche, lien avec la table RESOURCES"
        data_type: int64

      - name: vehicle_id
        description: "ID du véhicule associé à la tâche, lien avec la table RESOURCES"
        data_type: int64

      - name: location_id
        description: "ID de la localisation de la tâche"
        data_type: int64

      - name: device_code
        description: "Code métier du device (numéro de série)"
        data_type: string

      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: company_code
        description: "Code client de l'entreprise"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: unit_coeff_multi
        description: "Coefficient multiplicateur d'unité du produit"
        data_type: int64

      - name: unit_coeff_div
        description: "Coefficient diviseur d'unité du produit"
        data_type: int64

      - name: base_unit_quantity
        description: "Quantité unitaire (sans conditionnement)"
        data_type: int64

      - name: product_unit_price_task
        description: "Prix unitaire hors tax du produit au moment de la tâche"

      - name: product_unit_price_latest
        description: "Dernier Prix d'achat unitaire hors tax du produit"
        data_type: int64

      - name: load_quantity
        description: "Quantité produit chargée ou retirée"
        data_type: int64

      - name: load_valuation
        description: "Valorisation du chargement (quantité * prix unitaire)"
        data_type: int64

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_lcdp__livraison_tasks
    description: >
      Table intermédiaire des tâches de bon de livraison.
      Filtrée sur les tâches de type BON LIVRAISON (idtask_type=101)
      avec statut FAIT/VALIDE/ANNULE.

    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_id
        description: "ID du produit"
        data_type: int64
        tests:
          - not_null

      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: company_code
        description: "Code client de l'entreprise"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: base_unit_quantity
        description: "Quantité unitaire (sans conditionnement)"
        data_type: int64

      - name: product_unit_price_task
        description: "Prix unitaire hors tax du produit au moment de la tâche"

      - name: product_unit_price_latest
        description: "Dernier Prix d'achat unitaire hors tax du produit"
        data_type: int64

      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_lcdp__inventaire_tasks
    description: >
      Table intermédiaire des tâches de d'inventaire.
      Filtrée sur les tâches de type INVENTAIRE (idtask_type=162)
      avec statut FAIT/VALIDE/ANNULE.

    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_id
        description: "ID du produit"
        data_type: int64
        tests:
          - not_null

      - name: product_source_id
        description: "ID du produit source"
        data_type: int64

      - name: product_source_type
        description: "Type du produit source"
        data_type: string

      - name: source_code
        description: "Code source du produit"
        data_type: string

      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: base_unit_quantity
        description: "Quantité unitaire (sans conditionnement)"
        data_type: int64

      - name: product_unit_price_task
        description: "Prix unitaire hors tax du produit au moment de la tâche"

      - name: product_unit_price_latest
        description: "Dernier Prix d'achat unitaire hors tax du produit"
        data_type: int64

      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null


  - name: int_oracle_lcdp__ecart_inventaire_tasks
    description: >
      Table intermédiaire des tâches de d'ecart inventaire.
      Filtrée sur les tâches de type ECART INVENTAIRE (idtask_type=163)
      avec statut FAIT/VALIDE/ANNULE.

    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_id
        description: "ID du produit"
        data_type: int64
        tests:
          - not_null

      - name: product_source_id
        description: "ID du produit source"
        data_type: int64

      - name: product_source_type
        description: "Type du produit source"
        data_type: string

      - name: source_code
        description: "Code source du produit"
        data_type: string

      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: base_unit_quantity
        description: "Quantité unitaire (sans conditionnement)"
        data_type: int64

      - name: product_unit_price_task
        description: "Prix unitaire hors tax du produit au moment de la tâche"

      - name: product_unit_price_latest
        description: "Dernier Prix d'achat unitaire hors tax du produit"
        data_type: int64

      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_lcdp__reception_tasks
    description: >
      Table intermédiaire des tâches de RECEPTION.
      Filtrée sur les tâches de type RECEPTION (idtask_type=121)
      avec statut FAIT/VALIDE/ANNULE.

    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_id
        description: "ID du produit"
        data_type: int64
        tests:
          - not_null

      - name: product_destination_id
        description: "ID du produit de destination"
        data_type: int64

      - name: product_destination_type
        description: "Type du produit de destination"
        data_type: string

      - name: destination_code
        description: "Code de destination du produit"
        data_type: string

      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: base_unit_quantity
        description: "Quantité unitaire (sans conditionnement)"
        data_type: int64

      - name: product_unit_price_task
        description: "Prix unitaire hors tax du produit au moment de la tâche"

      - name: product_unit_price_latest
        description: "Dernier Prix d'achat unitaire hors tax du produit"
        data_type: int64

      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null


  - name: int_oracle_lcdp__livraison_interne_tasks
    description: >
      Table intermédiaire des tâches de Livraison interne.
      Filtrée sur les tâches de type LIVRAISON INTERNE (idtask_type=161)
      avec statut FAIT/VALIDE/ANNULE.

    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_id
        description: "ID du produit"
        data_type: int64
        tests:
          - not_null

      - name: product_source_id
        description: "ID du produit source"
        data_type: int64

      - name: product_source_type
        description: "Type du produit source"
        data_type: string

      - name: product_destination_id
        description: "ID du produit de destination"
        data_type: int64

      - name: product_destination_type
        description: "Type du produit de destination"
        data_type: string

      - name: destination_code
        description: "Code de destination du produit"
        data_type: string

      - name: source_code
        description: "Code source du produit"
        data_type: string

      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: base_unit_quantity
        description: "Quantité unitaire (sans conditionnement)"
        data_type: int64

      - name: product_unit_price_task
        description: "Prix unitaire hors tax du produit au moment de la tâche"

      - name: product_unit_price_latest
        description: "Dernier Prix d'achat unitaire hors tax du produit"
        data_type: int64

      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_lcdp__appro_tasks
    description: >
      Table intermédiaire des passages approvisionneurs.
      Filtrée sur les tâches de type PASSAGE APPRO (idtask_type=32)
      avec statut actif (code_status_record=1) et enrichie avec ressources (roadman, véhicule).

    columns:
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: device_id
        description: "ID du device associé à la tâche"
        data_type: int64

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_source_id
        description: "ID du produit source de la tâche"
        data_type: int64

      - name: product_destination_id
        description: "ID du produit destination de la tâche"
        data_type: int64

      - name: company_code
        description: "Code client de l'entreprise (company.code)"
        data_type: string

      - name: product_source_type
        description: "Type de la source produit"
        data_type: string

      - name: product_destination_type
        description: "Type de la destination produit"
        data_type: string

      - name: task_location_info
        description: "Informations de localisation de la tâche"
        data_type: string

      - name: task_status_code
        description: "Code du statut de la tâche (task_status.code)"
        data_type: string

      - name: task_start_date
        description: "Date et heure de début réel du passage appro"
        data_type: timestamp
        tests:
          - not_null

      - name: task_end_date
        description: "Date et heure de fin réel du passage appro"
        data_type: timestamp

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_lcdp__commande_interne
    description: >
      Table intermédiaire des mouvements internes (commandes internes).
      Filtrée sur les tâches de type LIVRAISON INTERNE (idtask_type = 132)
      avec statut FAIT / VALIDE / ANNULE, et labels de la famille STATUT_LIVRAISON.
      Contient les métriques de quantité et valorisation, avec les codes source et destination
      (entreprise ou ressource) associés.

    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation tâche-produit"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: task_id
        description: "Identifiant de la tâche (référence EVS.TASK)"
        data_type: int64
        tests:
          - not_null

      - name: company_id
        description: "Identifiant de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_id
        description: "Identifiant du produit concerné"
        data_type: int64
        tests:
          - not_null

      - name: product_source_id
        description: "Identifiant du produit source (COMPANY ou RESOURCES)"
        data_type: int64

      - name: product_source_type
        description: "Type du produit source (COMPANY ou RESOURCES)"
        data_type: string

      - name: product_destination_id
        description: "Identifiant du produit destination (COMPANY ou RESOURCES)"
        data_type: int64

      - name: product_destination_type
        description: "Type du produit destination (COMPANY ou RESOURCES)"
        data_type: string

      - name: source_code
        description: "Code de la source du mouvement (entreprise ou ressource)"
        data_type: string
        tests:
          - not_null

      - name: destination_code
        description: "Code de la destination du mouvement (entreprise ou ressource)"
        data_type: string
        tests:
          - not_null

      - name: product_code
        description: "Code métier du produit (référence EVS.PRODUCT)"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string

      - name: label_code
        description: "Code du label associé à la tâche (famille STATUT_LIVRAISON)"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de début de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: unit_coeff_multi
        description: "Coefficient multiplicateur d'unité du produit"
        data_type: int64

      - name: unit_coeff_div
        description: "Coefficient diviseur d'unité du produit"
        data_type: int64

      - name: base_unit_quantity
        description: "Quantité unitaire (sans conditionnement)"
        data_type: int64

      - name: product_unit_price_task
        description: "Prix unitaire hors tax du produit au moment de la tâche"

      - name: product_unit_price_latest
        description: "Dernier Prix d'achat unitaire hors tax du produit"
        data_type: int64

      - name: quantity
        description: "Quantité totale du produit transféré (avec coefficients unitaires)"
        data_type: numeric

      - name: valuation
        description: "Valorisation totale (quantité * prix unitaire net)"
        data_type: numeric

      - name: updated_at
        description: "Timestamp de dernière mise à jour de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création de la tâche"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle (suivi de synchronisation)"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_lcdp__inter_technique_tasks
    description: >
      Table intermédiaire des tâches d'intervention technique.
      Filtrée sur les tâches de type INTERVENTION TECHNIQUE (idtask_type=131)
      avec code_status_record=1 et real_start_date non null.
      Enrichie avec les labels pivotés (Statut inter, Objet intervent, DEVICE_CANCEL_REASON)
      et les ressources de type personne (idresources_type=2).

    columns:
      - name: task_id
        description: "Clé primaire - Identifiant unique de la tâche d'intervention technique"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: device_id
        description: "ID du device associé à la tâche"
        data_type: int64

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: resources_id
        description: "ID de la ressource personne (idresources_type=2) associée à la tâche"
        data_type: int64

      - name: company_code
        description: "Code client de l'entreprise"
        data_type: string

      - name: device_code
        description: "Code métier du device (numéro de série)"
        data_type: string

      - name: company_name
        description: "Nom de l'entreprise cliente"
        data_type: string

      - name: device_name
        description: "Nom du device"
        data_type: string

      - name: task_location_info
        description: "Informations d'accès de la localisation de la tâche"
        data_type: string

      - name: comments_self
        description: "Commentaires internes de la tâche"
        data_type: string

      - name: comments_peer
        description: "Commentaires peer de la tâche"
        data_type: string

      - name: task_start_date
        description: "Date et heure réelle de début de l'intervention technique"
        data_type: timestamp
        tests:
          - not_null

      - name: task_end_date
        description: "Date et heure réelle de fin de l'intervention technique"
        data_type: timestamp

      - name: task_status_code
        description: "Code statut de la tâche (depuis task_status)"
        data_type: string

      - name: statut_inter
        description: "Label pivoté - Code du statut de l'intervention (famille 'Statut inter')"
        data_type: string

      - name: objet_intervent
        description: "Label pivoté - Code de l'objet de l'intervention (famille 'Objet intervent')"
        data_type: string

      - name: device_cancel_reason
        description: "Label pivoté - Code de la raison d'annulation du device (famille 'DEVICE_CANCEL_REASON')"
        data_type: string

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_lcdp__pointage
    description: >
      Table intermédiaire des tâches des pointages roadman sur les débuts et fin de journées
      1 ligne = 1 tâche pointage.
      Filtrée sur les tâches de type POINTAGE et FILTRER sur label START_DAY (idtask_type=194, idlabel=2685,2686) et filtrage sur les tâches associé à des idresources
      avec code_status_record=1
    columns:
      - name: task_id
        description: >
          Identifiant unique de la tâche de pointage.
        tests:
          - not_null

      - name: company_id
        description: >
          Identifiant de l'entreprise (idcompany_peer de la tâche).
        tests:
          - not_null

      - name: resources_roadman_id
        description: >
          Identifiant de la ressource roadman (idresources_type=2) associée à la tâche.

      - name: roadman_code
        description: >
          Code métier du roadman associé à la tâche.

      - name: status_code
        description: >
          Code statut de la tâche (depuis task_status).

      - name: label_code
        description: >
          Code du label de la tâche. Filtré sur START_DAY (idlabel=2685).

      - name: date_pointage_jour
        description: >
          Date du jour du pointage (sans l'heure), extraite de real_start_date.
        tests:
          - not_null

      - name: date_pointage
        description: >
          Timestamp du pointage
        tests:
          - not_null
