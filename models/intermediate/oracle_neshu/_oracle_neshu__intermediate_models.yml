# models/intermediate/oracle_neshu/_oracle_neshu__intermediate_models.yml
version: 2

models:
  - name: int_oracle_neshu__telemetry_tasks
    description: >
      Table intermédiaire des tâches de télémétrie.
      Filtrée sur les tâches de type télémétrie (idtask_type=3) 
      avec statut FAIT/VALIDE et label TELEM_SOURCE.
      
    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null
          
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null
          
      - name: device_id
        description: "ID du device associé à la tâche"
        data_type: int64
        
      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64
          
      - name: product_id
        description: "ID du produit télémétrique"
        data_type: int64
        tests:
          - not_null
          
      - name: location_id
        description: "ID de la localisation de la tâche"
        data_type: int64
        
      - name: device_code
        description: "Code métier du device (numéro de série)"
        data_type: string
        
      - name: product_code
        description: "Code métier du produit"
        data_type: string
        
      - name: company_code
        description: "Code client de l'entreprise"
        data_type: string
        
      - name: company_name
        description: "Nom de l'entreprise cliente"
        data_type: string
        
      - name: task_location_info
        description: "Informations d'accès de la localisation de la tâche"
        data_type: string
        
      - name: task_start_date
        description: "Date et heure réelle de la tâche télémétrique"
        data_type: timestamp
        tests:
          - not_null
        
      - name: telemetry_quantity
        description: "Quantité télémétrique (toujours 1 par convention métier)"
        data_type: int64
        
      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null
          
      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null
          
      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_neshu__chargement_tasks
    description: >
      Table intermédiaire des tâches de chargement machine.
      Filtrée sur les tâches de type CHARGEMENT (idtask_type=13) 
      avec statut FAIT/VALIDE/ANNULE et label du chargement (LOADING / REMOVING).
      
    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null
          
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null
        
      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64
          
      - name: product_id
        description: "ID du produit"
        data_type: int64
        tests:
          - not_null

      - name: roadman_id
        description: "ID du roadman associé à la tâche, lien avec la table RESOURCES"
        data_type: int64

      - name: vehicle_id
        description: "ID du véhicule associé à la tâche, lien avec la table RESOURCES"
        data_type: int64

      - name: location_id
        description: "ID de la localisation de la tâche"
        data_type: int64
        
      - name: device_code
        description: "Code métier du device (numéro de série)"
        data_type: string
        
      - name: product_code
        description: "Code métier du produit"
        data_type: string
        
      - name: company_code
        description: "Code client de l'entreprise"
        data_type: string
        
      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null
        
      - name: load_quantity
        description: "Quantité produit chargée ou retirée"
        data_type: int64

      - name: load_valuation
        description: "Valorisation du chargement (quantité * prix unitaire)"
        data_type: int64
        
      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null
          
      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null
          
      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_neshu__livraison_tasks
    description: >
      Table intermédiaire des tâches de bon de livraison.
      Filtrée sur les tâches de type BON LIVRAISON (idtask_type=101) 
      avec statut FAIT/VALIDE/ANNULE.
      
    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null
          
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null
        
      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64
          
      - name: product_id
        description: "ID du produit"
        data_type: int64
        tests:
          - not_null
        
      - name: product_code
        description: "Code métier du produit"
        data_type: string
        
      - name: company_code
        description: "Code client de l'entreprise"
        data_type: string
        
      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null
        
      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64
        
      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null
          
      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null
          
      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_neshu__inventaire_tasks
    description: >
      Table intermédiaire des tâches de d'inventaire.
      Filtrée sur les tâches de type INVENTAIRE (idtask_type=162) 
      avec statut FAIT/VALIDE/ANNULE.
      
    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null
          
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null
        
      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64
          
      - name: product_id
        description: "ID du produit télémétrique"
        data_type: int64
        tests:
          - not_null

      - name: product_source_id
        description: "ID du produit source"
        data_type: int64

      - name: product_source_type
        description: "Type du produit source"
        data_type: string

      - name: source_code
        description: "Code source du produit"
        data_type: string
        
      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string 
        
      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null
        
      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64
        
      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null
          
      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null
          
      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null


  - name: int_oracle_neshu__ecart_inventaire_tasks
    description: >
      Table intermédiaire des tâches de d'ecart inventaire.
      Filtrée sur les tâches de type ECART INVENTAIRE (idtask_type=163) 
      avec statut FAIT/VALIDE/ANNULE.
      
    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null
          
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null
        
      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64
          
      - name: product_id
        description: "ID du produit télémétrique"
        data_type: int64
        tests:
          - not_null

      - name: product_source_id
        description: "ID du produit source"
        data_type: int64

      - name: product_source_type
        description: "Type du produit source"
        data_type: string

      - name: source_code
        description: "Code source du produit"
        data_type: string
        
      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string 
        
      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null
        
      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64
        
      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null
          
      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null
          
      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_neshu__reception_tasks
    description: >
      Table intermédiaire des tâches de RECEPTION.
      Filtrée sur les tâches de type RECEPTION (idtask_type=121) 
      avec statut FAIT/VALIDE/ANNULE.
      
    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null
          
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null
        
      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64
          
      - name: product_id
        description: "ID du produit télémétrique"
        data_type: int64
        tests:
          - not_null

      - name: product_destination_id
        description: "ID du produit de destination"
        data_type: int64

      - name: product_destination_type
        description: "Type du produit de destination"
        data_type: string

      - name: destination_code
        description: "Code de destination du produit"
        data_type: string
        
      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string 
        
      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null
        
      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64
        
      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null
          
      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null
          
      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null


  - name: int_oracle_neshu__mouvement_interne_tasks
    description: >
      Table intermédiaire des tâches de Mouvement interne.
      Filtrée sur les tâches de type MOUVEMENT INTERNE (idtask_type=161) 
      avec statut FAIT/VALIDE/ANNULE.
      
    columns:
      - name: task_product_id
        description: "Clé primaire de task_has_product - Identifiant unique de la relation task-produit"
        data_type: int64
        tests:
          - unique
          - not_null
          
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - not_null
        
      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64
          
      - name: product_id
        description: "ID du produit télémétrique"
        data_type: int64
        tests:
          - not_null

      - name: product_source_id
        description: "ID du produit source"
        data_type: int64

      - name: product_source_type
        description: "Type du produit source"
        data_type: string

      - name: product_destination_id
        description: "ID du produit de destination"
        data_type: int64

      - name: product_destination_type
        description: "Type du produit de destination"
        data_type: string

      - name: destination_code
        description: "Code de destination du produit"
        data_type: string

      - name: source_code
        description: "Code source du produit"
        data_type: string
        
      - name: product_code
        description: "Code métier du produit"
        data_type: string

      - name: task_status_code
        description: "Code statut de la tâche (FAIT, VALIDE, ANNULE)"
        data_type: string 
        
      - name: task_start_date
        description: "Date et heure réelle de la tâche"
        data_type: timestamp
        tests:
          - not_null
        
      - name: quantity
        description: "Quantité produit"
        data_type: int64

      - name: valuation
        description: "Valorisation du produit (quantité * prix unitaire)"
        data_type: int64
        
      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null
          
      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null
          
      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

  - name: int_oracle_neshu__appro_tasks
    description: >
      Table intermédiaire des passages approvisionneurs.
      Filtrée sur les tâches de type PASSAGE APPRO (idtask_type=32) 
      avec statut actif (code_status_record=1) et enrichie avec ressources (roadman, véhicule).
      
    columns:
      - name: task_id
        description: "ID de la tâche (référence vers EVS.TASK)"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: device_id
        description: "ID du device associé à la tâche"
        data_type: int64

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64

      - name: product_source_id
        description: "ID du produit source de la tâche"
        data_type: int64

      - name: product_destination_id
        description: "ID du produit destination de la tâche"
        data_type: int64

      - name: roadman_id
        description: "ID du roadman associé à la tâche (resources type=2)"
        data_type: int64

      - name: vehicle_id
        description: "ID du véhicule associé à la tâche (resources type=3)"
        data_type: int64

      - name: company_code
        description: "Code client de l'entreprise (company.code)"
        data_type: string

      - name: roadman_code
        description: "Code métier du roadman (resources.code)"
        data_type: string

      - name: vehicle_code
        description: "Code métier du véhicule (resources.code)"
        data_type: string

      - name: task_status_code
        description: "Code du statut de la tâche (task_status.code)"
        data_type: string

      - name: product_source_type
        description: "Type de la source produit"
        data_type: string

      - name: product_destination_type
        description: "Type de la destination produit"
        data_type: string

      - name: task_location_info
        description: "Informations de localisation de la tâche"
        data_type: string

      - name: task_start_date
        description: "Date et heure de début réel du passage appro"
        data_type: timestamp
        tests:
          - not_null

      - name: task_end_date
        description: "Date et heure de fin réel du passage appro"
        data_type: timestamp

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null


  - name: int_oracle_neshu__inter_techinique_tasks
    description: >
      Table intermédiaire des inter technique.
      Filtrée sur les tâches de type INTER TECHNIQUE (idtask_type=131)  & filtré sur label C4 Détartrage/filtre
      avec statut actif (code_status_record=1) et enrichie avec code produit.
      
    columns:
      - name: task_id
        description: "ID de la tâche"
        data_type: int64
        tests:
          - unique
          - not_null

      - name: device_id
        description: "ID du device associé à la tâche"
        data_type: int64
        tests:
          - not_null

      - name: company_id
        description: "ID de l'entreprise cliente (peer company)"
        data_type: int64
        tests:
          - not_null 

      - name: product_id
        description: "ID du produit"
        data_type: int64

      - name: company_code
        description: "Code client de l'entreprise (company.code)"
        data_type: string

      - name: product_code
        description: "Code produit (si utilisé pour la tâche)"
        data_type: string

      - name: task_status_code
        description: "Code du statut de la tâche (task_status.code)"
        data_type: string

      - name: statut_inter
        description: "Statut de l'intervention technique (TERMINE ou envoyé à la technique)"
        data_type: string

      - name: dc04
        description: "Label famille DC04 qui correspond au : Détail C4 -"
        data_type: string
      
      - name: mission_type
        description: "Type de mission"
        data_type: string

      - name: objet_intervent
        description: "Objet de l'intervention : Filtré sur C4 - Détartrage/filtre"
        data_type: string

      - name: task_start_date
        description: "Date et heure de début réel du passage appro"
        data_type: timestamp
        tests:
          - not_null

      - name: task_end_date
        description: "Date et heure de fin réel du passage appro"
        data_type: timestamp

      - name: updated_at
        description: "Timestamp de dernière modification (pour incrément)"
        data_type: timestamp
        tests:
          - not_null

      - name: created_at
        description: "Timestamp de création"
        data_type: timestamp
        tests:
          - not_null

      - name: extracted_at
        description: "Timestamp d'extraction depuis Oracle"
        data_type: timestamp
        tests:
          - not_null

    # Table intermédiaire reliant les machines Oracle NESHU aux matériels Yuman (avec enrichissement client et site)
  - name: int_oracle_neshu__machines_yuman_maintenance_base
    description: >
      Table intermédiaire reliant les machines Oracle NESHU (issues de dim_oracle_neshu__device)
      aux matériels Yuman (materials, sites, clients, catégories). 
      Sert de dimension de référence pour les analyses de maintenance,
      enrichie avec informations client et site.
    columns:
      - name: device_id
        description: Identifiant unique de la machine dans Oracle.
        tests:
          - not_null
          - unique
      - name: material_id
        description: Identifiant du matériel dans Yuman.

      - name: device_code
        description: Code machine Oracle avec préfixe 'NESH_'.
        tests:
          - not_null
      - name: device_name
        description: Libellé de la machine Oracle.
      - name: company_code
        description: Code société Oracle, préfixé 'NESH_' et filtré sur le format CN[0-9]{4}.
      - name: last_installation_date
        description: Dernière date d’installation de la machine (Oracle).
      - name: material_serial_number
        description: Numéro de série du matériel Yuman (matché avec le device_code Oracle).
      - name: client_id
        description: Identifiant du client Yuman associé.
      - name: client_code
        description: Code client Yuman associé à la machine.
      - name: client_name
        description: Nom du client Yuman associé.
      - name: client_category
        description: Catégorie du client Yuman.
      - name: site_id
        description: Identifiant du site Yuman associé.
      - name: site_code
        description: Code site Yuman associé (excluant dépôts et ateliers).
      - name: site_postal_code
        description: Code postal du site Yuman associé.
      - name: material_created_at
        description: Date de création du matériel Yuman.
      - name: material_updated_at
        description: Dernière mise à jour du matériel Yuman.
