# models/marts/yuman/_yuman__marts_models.yml

version: 2

models:

  - name: dim_yuman__clients
    description: "Clients Marts Yuman"
    columns:
      - name: client_id
        description: "Identifiant unique du client"
        tests:
          - unique
          - not_null

      - name: client_code
        description: "Code du client"

      - name: client_name
        description: "Nom du client"

      - name: client_category
        description: "Catégorie du client (Spécifique NESHU : OR / ARGENT / BRONZE)"

      - name: client_address
        description: "Adresse du client"

      - name: is_active
        description: "Statut d'activation du client"

      - name: partner_name
        description: "Nom du partenaire associé au client"


  - name: dim_yuman__sites
    description: "Sites Marts Yuman"
    columns:
      - name: site_id
        description: "Identifiant unique du site"
        tests:
          - unique
          - not_null

      - name: client_id
        description: "Référence vers le client propriétaire"
        tests:
          - not_null
          - relationships:
              to: ref('dim_yuman__clients')
              field: client_id

      - name: agency_id
        description: "Identifiant de l'agence associée au site"

      - name: site_code
        description: "Code du site"

      - name: site_name
        description: "Nom du site"

      - name: site_address
        description: "Adresse du site"

      - name: site_postal_code
        description: "Code postal du site"

      - name: created_at
        description: "Date de création de l'enregistrement"

      - name: updated_at
        description: "Date de la dernière mise à jour de l'enregistrement"


  - name: dim_yuman__materials
    description: "Matériaux Marts Yuman enrichie avec les informations catégorie material"
    columns:
      - name: material_id
        description: "Identifiant unique du matériau"
        tests:
          - unique
          - not_null

      - name: site_id
        description: "Référence vers le site propriétaire"
        tests:
          - not_null
          - relationships:
              to: ref('dim_yuman__sites')
              field: site_id

      - name: material_description
        description: "Description de la machine"

      - name: material_name
        description: "Nom de la machine"

      - name: material_brand
        description: "Marque de la machine"

      - name: material_serial_number
        description: "Numéro de série de la machine"

      - name: category_name
        description: "Catégorie de la machine"

      - name: material_in_service_date
        description: "Date de mise en service de la machine"

      - name: created_at
        description: "Date de création de l'enregistrement"

      - name: updated_at
        description: "Date de la dernière mise à jour de l'enregistrement"


  - name: dim_yuman__materials_clients
    description: >
      Dimension materials enrichie avec les informations de sites et de clients
    columns:
      # Informations Machine
      - name: material_id
        description: "Identifiant unique de la machine"
        tests:
          - not_null
          - unique

      - name: material_description
        description: "Type de machine"

      - name: material_brand
        description: "Marque de la machine"

      - name: material_serial_number
        description: "Numéro de série de la machine"

      - name: category_name
        description: "Catégorie de la machine"

      - name: material_in_service_date
        description: "Date de mise en service de la machine"

      # Informations Client
      - name: client_id
        description: "Id du client associé à la machine"
        tests:
          - not_null

      - name: client_code
        description: "Code du client associé à la machine"

      - name: client_address
        description: "Adresse du client associé à la machine"

      - name: client_name
        description: "Nom du client associé à la machine"

      - name: partner_name
        description: "Nom du partenaire associé à la machine"

      # Informations Site
      - name: site_id
        description: "Id du site associé à la machine"
        tests:
          - not_null

      - name: site_address
        description: "Adresse du site associé à la machine"

      - name: site_name
        description: "Nom du site associé à la machine"

      - name: site_postal_code
        description: "Code postal du site associé à la machine"


  - name: fct_yuman__workorder_pricing
    description: >
      Table de fait marts de tarification automatique des interventions (workorders).
      Ce modèle enrichit les données unifiées des interventions et des demandes issues de 
      `int_yuman__demands_workorders_enriched` avec les référentiels de types d'intervention,
      machines, tarifications et zones géographiques. 
      Il calcule les prix automatiques des interventions selon les règles de récurrence, 
      de partenaire et de localisation (métropole).

    columns:
      # --- IDENTIFIANTS ---
      - name: demand_id
        description: Identifiant unique de la demande d'intervention.
        tests:
          - unique
      - name: workorder_id
        description: Identifiant unique du bon de travail.
        tests:
          - unique
      - name: material_id
        description: Identifiant du matériel concerné.
        tests:
          - relationships:
              to: ref('dim_yuman__materials')
              field: material_id
      - name: site_id
        description: Identifiant du site client.
        tests:
          - relationships:
              to: ref('dim_yuman__sites')
              field: site_id
      - name: client_id
        description: Identifiant du client.
        tests:
          - relationships:
              to: ref('dim_yuman__clients')
              field: client_id
      - name: technician_id
        description: Identifiant du technicien associé.
      - name: manager_id
        description: Identifiant du manager ou responsable associé.

      # --- DEMANDE D'INTERVENTION ---
      - name: demand_description
        description: Description textuelle de la demande d’intervention.
      - name: demand_status
        description: Statut de la demande d’intervention.
      - name: demand_created_at
        description: Date de création de la demande.
      - name: demand_updated_at
        description: Date de dernière mise à jour de la demande.
      - name: demand_category_name
        description: Catégorie de la demande d’intervention.

      # --- BON DE TRAVAIL ---
      - name: workorder_number
        description: Numéro unique du bon de travail.
      - name: workorder_category
        description: Catégorie ou type brut du bon de travail.
      - name: workorder_status
        description: Statut actuel du bon de travail.
      - name: workorder_technician_name
        description: Nom du technicien affecté au bon de travail.
      - name: workorder_date_creation
        description: Date de création du bon de travail.
      - name: workorder_motif_non_intervention
        description: Motif de non-intervention, si applicable.
      - name: workorder_detail_non_intervention
        description: Détail du motif de non-intervention, si applicable.
      - name: date_planned
        description: Date planifiée de l’intervention.
      - name: date_started
        description: Date de début de l’intervention.
      - name: date_done
        description: Date de clôture de l’intervention.

      # --- CLIENT & SITE ---
      - name: partner_name
        description: Nom du partenaire ou marque associée au client.
      - name: client_code
        description: Code unique du client.
      - name: client_name
        description: Nom du client.
      - name: client_category
        description: Catégorie commerciale ou segment du client.
      - name: client_is_active
        description: Indique si le client est actif.
      - name: site_code
        description: Code unique du site.
      - name: site_name
        description: Nom du site client.
      - name: site_address
        description: Adresse complète du site client.
      - name: site_postal_code
        description: Code postal fourni dans le système Yuman.
      - name: postal_code_site
        description: Code postal normalisé du site (corrigé ou extrait de la description si manquant).

      # --- MATERIEL ---
      - name: material_serial_number
        description: Numéro de série du matériel concerné.
      - name: workorder_type_raw
        description: Type brut de l’intervention avant normalisation.
      - name: machine_raw
        description: Catégorie brute du matériel avant nettoyage.
      - name: workorder_type_clean
        description: Type d’intervention normalisé (préventif, curatif, installation…).
      - name: machine_clean
        description: Catégorie de machine normalisée.

      # --- LOCALISATION ---
      - name: metropolitan
        description: Indicateur binaire (1 = métropole, 0 = hors métropole).
      - name: metropole_city
        description: Ville de la métropole associée à l'intervention.
      - name: recurrence_count
        description: Nombre d’interventions réalisées pour un même client le même jour (récurrence).

      # --- TARIFICATION ---
      - name: pricing_type
        description: Type de tarification appliquée (Tarif normal, Remise niv1, Remise niv2).
      - name: pricing_key_used
        description: Clé de tarification générée pour le matching avec la table de référence.
      - name: amount
        description: Montant appliqué selon la tarification automatique.
      - name: prod_number
        description: Code produit ou référence tarifaire associée.
      - name: to_invoice
        description: Indique si le bon d’intervention doit être facturé (true = à facturer).
      - name: billing_validation_status
        description: Statut de validation de la facturation (VALIDATED, MISSING_TARIF, NOT_BILLABLE).

  - name: fct_yuman__workorder_delais_neshu
    description: >
      Table de fait marts de tarification automatique des interventions (workorders).
      Ce modèle enrichit les données unifiées des interventions et des demandes issues de 
      `int_yuman__demands_workorders_enriched` avec les référentiels de types d'intervention,
      machines, tarifications et zones géographiques. 
      Il calcule les prix automatiques des interventions selon les règles de récurrence, 
      de partenaire et de localisation (métropole).

    columns:
      # --- IDENTIFIANTS ---
      - name: demand_id
        description: Identifiant unique de la demande d'intervention.
        tests:
          - unique
      - name: workorder_id
        description: Identifiant unique du bon de travail.
        tests:
          - unique
      - name: material_id
        description: Identifiant du matériel concerné.
        tests:
          - relationships:
              to: ref('dim_yuman__materials')
              field: material_id
      - name: site_id
        description: Identifiant du site client.
        tests:
          - relationships:
              to: ref('dim_yuman__sites')
              field: site_id
      - name: client_id
        description: Identifiant du client.
        tests:
          - relationships:
              to: ref('dim_yuman__clients')
              field: client_id
      - name: technician_id
        description: Identifiant du technicien associé.
      - name: manager_id
        description: Identifiant du manager ou responsable associé.

      # --- DEMANDE D'INTERVENTION ---
      - name: demand_description
        description: Description textuelle de la demande d’intervention.
      - name: demand_status
        description: Statut de la demande d’intervention.
      - name: demand_created_at
        description: Date de création de la demande.
      - name: demand_updated_at
        description: Date de dernière mise à jour de la demande.
      - name: demand_category_name
        description: Catégorie de la demande d’intervention.

      # --- BON DE TRAVAIL ---
      - name: workorder_number
        description: Numéro unique du bon de travail.
      - name: workorder_category
        description: Catégorie ou type brut du bon de travail.
      - name: workorder_status
        description: Statut actuel du bon de travail.
      - name: workorder_technician_name
        description: Nom du technicien affecté au bon de travail.
      - name: workorder_date_creation
        description: Date de création du bon de travail.
      - name: workorder_motif_non_intervention
        description: Motif de non-intervention, si applicable.
      - name: workorder_detail_non_intervention
        description: Détail du motif de non-intervention, si applicable.
      - name: date_planned
        description: Date planifiée de l’intervention.
      - name: date_started
        description: Date de début de l’intervention.
      - name: date_done
        description: Date de clôture de l’intervention.

      # --- CLIENT & SITE ---
      - name: partner_name
        description: Nom du partenaire ou marque associée au client.
      - name: client_code
        description: Code unique du client.
      - name: client_name
        description: Nom du client.
      - name: client_category
        description: Catégorie commerciale ou segment du client.
      - name: client_is_active
        description: Indique si le client est actif.
      - name: site_code
        description: Code unique du site.
      - name: site_name
        description: Nom du site client.
      - name: site_address
        description: Adresse complète du site client.
      - name: site_postal_code
        description: Code postal fourni dans le système Yuman.
      - name: postal_code_site
        description: Code postal normalisé du site (corrigé ou extrait de la description si manquant).

      # --- MATERIEL ---
      - name: material_serial_number
        description: Numéro de série du matériel concerné.
      - name: workorder_type_raw
        description: Type brut de l’intervention avant normalisation.
      - name: machine_raw
        description: Catégorie brute du matériel avant nettoyage.
      - name: workorder_type_clean
        description: Type d’intervention normalisé (préventif, curatif, installation…).
      - name: machine_clean
        description: Catégorie de machine normalisée.

      # --- LOCALISATION ---
      - name: metropolitan
        description: Indicateur binaire (1 = métropole, 0 = hors métropole).
      - name: metropole_city
        description: Ville de la métropole associée à l'intervention.
      - name: recurrence_count
        description: Nombre d’interventions réalisées pour un même client le même jour (récurrence).

      # --- TARIFICATION ---
      - name: pricing_type
        description: Type de tarification appliquée (Tarif normal, Remise niv1, Remise niv2).
      - name: pricing_key_used
        description: Clé de tarification générée pour le matching avec la table de référence.
      - name: amount
        description: Montant appliqué selon la tarification automatique.
      - name: prod_number
        description: Code produit ou référence tarifaire associée.
      - name: to_invoice
        description: Indique si le bon d’intervention doit être facturé (true = à facturer).
      - name: billing_validation_status
        description: Statut de validation de la facturation (VALIDATED, MISSING_TARIF, NOT_BILLABLE).

      # --- INDICATEURS DE DELAIS ---
      - name: type_delai
        description: Type de delai selon les règles NESHU (Resp Technique)
      - name: delai_jours_ouvres
        description: Nombre de jours ouvrés entre la date de creation de reference et la date de fin
      - name: date_creation_ref
        description: Date de creation de reference, selon les regles NESHU