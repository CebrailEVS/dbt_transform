# models/marts/oracle_neshu/_oracle_neshu__marts_models.yml
version: 2

models:
  # COMPANY
  - name: dim_oracle_neshu__company
    description: >
      Dimension client/company enrichie à partir des labels associés (région, secteur, statut, etc.)
      et des informations de localisation.
    columns:
      - name: idcompany
        description: "Identifiant unique de la société"
        tests:
          - not_null
          - unique

      - name: idcompany_type
        description: "ID Type de société (ex : client, fournisseur...)"

      - name: company_code
        description: "Code client"

      - name: company_name
        description: "Nom de la société"

      - name: region
        description: "Région géographique de la société (label REGION)"

      - name: sector
        description: "Secteur d’activité (HORECA/OFFICE) (label SECTEUR_ACTVITE)"

      - name: sector_code
        description: "Code sectoriel associé, lien avec ceux de nespresso (label CODE_SECTEUR)"

      - name: activity_sector
        description: "Secteur d'activité détaillé (label SECTEUR_DACTIVITE)"

      - name: employee_range
        description: "Tranche de collaborateurs (label TRANCHE_COLLAB)"

      - name: company_type
        description: "Type d’entreprise (label TYPECOMPAGNIE)"

      - name: company_economic_model
        description: "Modèle économique client (label MODELEECOCLIENT)"

      - name: client_status
        description: "Statut client (OR/ARGENT/BRONZE) (label STATUT_CLIENT)"

      - name: is_active
        description: >
          Indique si la société est active (label ISACTIVE). 
          TRUE si 'yes', sinon FALSE.

      - name: key_account
        description: "KA grand compte (label KA)"

      - name: katiers
        description: "Label KATIERS lié au KA"

      - name: remote_work
        description: "Indicateur du nombre de télétravail par semaine (label TELETRAVAIL)"

      - name: proadman
        description: "Nombre de passage roadman (label PROADMAN)"

      - name: gsm
        description: "Gobelet Sucre Melangeur FORMULE (label GSM_TERRAIN)"

      - name: badge
        description: "Indicateur de badge client (label BADGE)"

      - name: recycling
        description: "Indicateur de recyclage (label RECYCLAGE)"

      - name: address1
        description: "Adresse principale (ligne 1)"

      - name: address2
        description: "Adresse complémentaire (ligne 2)"

      - name: city
        description: "Ville de la société"

      - name: postal_code
        description: "Code postal de la société"

      - name: country
        description: "Pays de la société"

      - name: created_at
        description: "Date de création dans la base source"

      - name: updated_at
        description: "Date de dernière mise à jour dans la base source"

  # PRODUCT
  - name: dim_oracle_neshu__product
    description: >
      Dimension produit enrichie à partir des labels associés (type, famille, groupe, marque, etc.)
      et filtrée sur les produits de type 1 (produit) et 5 (ligne de prix).
    columns:
      - name: idproduct
        description: "Identifiant unique du produit"
        tests:
          - not_null
          - unique

      - name: idproduct_type
        description: "Type de produit (1 = produit, 5 = ligne de prix)"

      - name: product_code
        description: "Code produit (référence interne)"

      - name: product_name
        description: "Nom du produit"

      - name: purchase_unit_price
        description: "Prix d'achat unitaire du produit"

      - name: product_brand
        description: "Marque du produit, extraite du label MARQUEP"

      - name: product_owner
        description: "Propriétaire du produit, via label PROPRIETAIRE"

      - name: product_family
        description: "Famille produit (ex : CAFE CAPSULES, THE), via label FAMILLE"

      - name: product_bio
        description: "Indication BIO ou non (via label BIO)"

      - name: product_group
        description: "Groupe produit (ACCESSOIRES, SNACKING...), via label GROUPE"

      - name: product_type
        description: >
          Typologie produit standardisée selon règles métier :
          ex. 'CAFE CAPS', 'THE', 'CHOCOLATS VAN HOUTEN', 'BOISSONS GOURMANDES'.
  
      - name: is_active
        description: >
          État d'activité du produit, converti en booléen :
          TRUE si le label ISACTIVE = 'YES', sinon FALSE.

      - name: created_at
        description: "Date de création du produit dans la source"

      - name: updated_at
        description: "Date de dernière mise à jour du produit dans la source"

    # DEVICE
  - name: dim_oracle_neshu__device
    description: >
      Dimension device enrichie à partir des labels associés (état, statut, gamme, catégorie, marque, etc.),
      filtrée sur les machines (type 1).
    columns:
      - name: iddevice
        description: "Identifiant unique de la machine"
        tests:
          - not_null
          - unique

      - name: iddevice_type
        description: "Type de machine (1 = machine, autres ignorés ici)"

      - name: idcompany_customer
        description: "Identifiant du client (company) auquel est rattachée la machine"
        tests:
          - not_null
          - relationships:
              to: ref('dim_oracle_neshu__company')
              field: idcompany

      - name: idlocation
        description: "Identifiant de localisation"

      - name: device_code
        description: "Code interne de la machine"

      - name: device_name
        description: "Nom de la machine"

      - name: company_code
        description: "Code client associé à la machine"

      - name: device_brand
        description: "Marque de la machine (label MARQUE)"

      - name: device_gamme
        description: "Gamme de la machine (label GAMME)"

      - name: device_category
        description: "Catégorie de la machine (label CATEGORIE)"

      - name: device_economic_model
        description: "Modèle économique de la machine (label MODECOMA)"

      - name: is_active
        description: >
          Indique si la machine est considérée comme active selon le label ISACTIVE.
          TRUE si 'yes', sinon FALSE (converti en booléen).

      - name: device_location
        description: "Informations d'accès au site de la machine (depuis la table location)"

      - name: last_installation_date
        description: "Date de dernière installation de la machine"

      - name: created_at
        description: "Date de création de la machine dans la base source"

      - name: updated_at
        description: "Date de dernière mise à jour de la machine dans la base source"

# FACT BUSINESS REVIEW
  - name: fct_oracle_neshu__conso_business_review
    description: >
      Table de faits des consommations clients pour la Business Review Neshu.
      Consolidation des données télémétrie, chargement et livraison avec application
      des règles métier spécifiques (gratuité vs payant, types de produits, etc.).
      Utilisée pour les analyses de consommation, comparatifs annuels et reporting client.
    
    columns:
      # === IDENTIFIANTS ===
      - name: company_id
        description: "Identifiant unique de la société cliente"
        tests:
          - not_null
          - relationships:
              to: ref('dim_oracle_neshu__company')
              field: idcompany

      - name: device_id
        description: "Identifiant de la machine (NULL pour les livraisons directes)"
        tests:
          - relationships:
              to: ref('dim_oracle_neshu__device')
              field: iddevice

      - name: location_id
        description: "Identifiant de localisation (NULL pour les livraisons)"

      - name: product_id
        description: "Identifiant unique du produit"
        tests:
          - not_null
          - relationships:
              to: ref('dim_oracle_neshu__product')
              field: idproduct

      # === COMPANY ===
      - name: company_code
        description: "Code client (ex: CN1234)"
        tests:
          - not_null

      - name: company_name
        description: "Nom de la société cliente"
        tests:
          - not_null

      # === LOCALISATION ===
      - name: location
        description: "Localisation de la consommation (Localisation task par défault, si vide => prendre localisation device) ou 'LIVRAISON' pour les livraisons directes"

      # === MACHINE ===
      - name: device_serial_number
        description: "Numéro de série de la machine ou 'LIVRAISON'"

      - name: device_name
        description: "Nom de la machine ou 'LIVRAISON'"

      - name: device_brand
        description: "Marque de la machine (NESPRESSO, NESTLE, ANIMO) ou 'LIVRAISON'"

      - name: device_economic_model
        description: "Modèle économique (Participatif valeurs, Participatif unités, Payant) ou 'LIVRAISON'"

      # === PRODUIT ===
      - name: product_name
        description: "Nom complet du produit"
        tests:
          - not_null

      - name: product_brand
        description: "Marque du produit"

      - name: product_family
        description: "Famille de produits"

      - name: product_group
        description: "Groupe de produits"

      - name: product_type
        description: "Type de produit (adapté aux règles métier)"
        tests:
          - not_null
          - accepted_values:
              values: 
                - 'THE'
                - 'CAFE CAPS'
                - 'CHOCOLATS VAN HOUTEN'
                - 'BOISSONS GOURMANDES'
                - 'ACCESSOIRES'
                - 'CAFENOIR'
                - 'INDEFINI'
                - 'SNACKING'
                - 'BOISSONS FRAICHES'

      # === CONTEXTE ===
      - name: consumption_date
        description: "Date de consommation (format DATE)"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: "'2020-01-01'"
              max_value: "current_date()"

      - name: data_source
        description: "Source des données de consommation"
        tests:
          - not_null
          - accepted_values:
              values: ['TELEMETRIE', 'CHARGEMENT', 'LIVRAISON']

      # === MESURES ===
      - name: quantity
        description: >
          Quantité consommée (ajustée selon les règles produit).
          Multiplicateurs appliqués pour les rames, boîtes, etc.
        tests:
          - not_null

      # === METADONNEES ===
      - name: dbt_updated_at
        description: "Timestamp de dernière mise à jour par dbt"
        tests:
          - not_null

      - name: dbt_invocation_id
        description: "ID unique de l'exécution dbt"
        tests:
          - not_null

    # === TESTS AU NIVEAU TABLE ===
    tests:
      # Test d'unicité sur la combinaison clé
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - company_id
            - device_id
            - product_id
            - location_id
            - location
            - consumption_date
            - data_source
          name: unique_consumption_record

      # Test de cohérence : pas de device_id NULL sauf pour LIVRAISON
      - dbt_utils.expression_is_true:
          expression: "(device_id IS NOT NULL) OR (data_source = 'LIVRAISON')"
          name: device_id_required_except_livraison

# FACT PASSAGES APPRO BUSINESS REVIEW
  - name: fct_oracle_neshu__pa_business_review
    description: >
      Table de faits des passages appro (Business Review Neshu).
      Permet de tracer le passage des roadmen chez les clients à partir de 2025,
      avec enrichissement des informations clients et machines.
    
    columns:
      # === IDENTIFIANTS ===
      - name: task_id
        description: "Identifiant unique de la tâche de passage appro"
        tests:
          - not_null
          - unique

      - name: company_code
        description: "Code client (ex: CN1234)"
        tests:
          - not_null

      - name: company_info
        description: "Concaténation du nom de la société et du code client"
        tests:
          - not_null

      - name: device_id
        description: "Identifiant unique de la machine associée au passage"
        tests:
          - not_null
          - relationships:
              to: ref('dim_oracle_neshu__device')
              field: iddevice

      - name: device_info
        description: "Concaténation de la marque et du code machine"
        tests:
          - not_null

      # === DATES ===
      - name: task_start_date
        description: "Horodatage de début de tâche"
        tests:
          - not_null

      - name: task_start_date_day
        description: "Date (jour) de début de tâche, utilisée pour les filtres/partitionnement"

      - name: task_end_date
        description: "Horodatage de fin de tâche (NULL si non terminée)"

      # === STATUTS ===
      - name: task_status_code
        description: "Statut de la tâche (PREVU, FAIT, ENCOURS, etc.)"
        tests:
          - not_null

      - name: mission_faite
        description: "Indicateur binaire : 1 si la mission est faite, sinon 0"
        tests:
          - not_null

      - name: mission_prevue
        description: "Indicateur binaire : 1 si la mission est prévue ou faite ou en cours"
        tests:
          - not_null
