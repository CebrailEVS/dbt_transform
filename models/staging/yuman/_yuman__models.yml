# models/staging/_yuman__models.yml
version: 2

models:
  - name: stg_yuman__clients
    description: "Clients transformés et nettoyés depuis l'API Yuman"
    columns:
      - name: client_id
        description: "Identifiant unique du client"
        tests:
          - unique
          - not_null
      - name: client_code
        description: "Code du client"
      - name: client_name
        description: "Nom du client"
      - name: client_category
        description: "Catégorie du client (Spécifique NESHU : OR / ARGENT / BRONZE)"
      - name: client_adress
        description: "Adresse du client"

  - name: stg_yuman__contacts
    description: "Contacts transformés et nettoyés depuis l'API Yuman"
    columns:
      - name: contact_id
        description: "Identifiant unique du contact"
        tests:
          - unique
          - not_null
      - name: client_id
        description: "Référence vers le client rattaché"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__clients')
                field: client_id
      - name: site_id
        description: "Référence vers le site rattaché"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__sites')
                field: site_id
      - name: category_id
        description: "Identifiant de la catégorie du contact"
      - name: contact_name
        description: "Nom du contact"
      - name: contact_title
        description: "Civilité du contact (mr, mrs, etc.)"
      - name: contact_phone
        description: "Numéro de téléphone fixe"
      - name: contact_mobile
        description: "Numéro de téléphone mobile"
      - name: contact_email
        description: "Adresse e-mail du contact"
      - name: contact_observation
        description: "Observations libres sur le contact"
      - name: external_reference
        description: "Référence externe du contact"
      - name: external_reference_vendor
        description: "Référence externe fournisseur du contact"
      - name: created_at
        description: "Date de création de l'enregistrement"
        tests:
          - not_null
      - name: updated_at
        description: "Date de dernière mise à jour"
      - name: extracted_at
        description: "Date d'extraction depuis la source (Singer/Meltano)"
      - name: deleted_at
        description: "Date de suppression (soft delete)"

  - name: stg_yuman__sites
    description: "Sites transformés et nettoyés depuis l'API Yuman"
    columns:
      - name: site_id
        description: "Identifiant unique du site"
        tests:
          - unique
          - not_null
      - name: client_id
        description: "Référence vers le client propriétaire"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_yuman__clients')
                field: client_id

  - name: stg_yuman__materials
    description: "Matériaux transformés et nettoyés depuis l'API Yuman"
    columns:
      - name: material_id
        description: "Identifiant unique du matériau"
        tests:
          - unique
          - not_null
      - name: site_id
        description: "Référence vers le site propriétaire"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_yuman__sites')
                field: site_id
      - name: category_id
        description: "Référence vers la catégorie du matériau"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__materials_categories')
                field: category_id

  - name: stg_yuman__products
    description: "Produits transformés et nettoyés depuis l'API Yuman"
    columns:
      - name: product_id
        description: "Identifiant unique du produit"
        tests:
          - unique
          - not_null

  - name: stg_yuman__users
    description: "Utilisateurs transformés et nettoyés depuis l'API Yuman"
    columns:
      - name: user_id
        description: "Identifiant unique de l'utilisateur"
        tests:
          - unique
          - not_null

  - name: stg_yuman__workorder_demands_categories
    description: "Catégories de demandes d'intervention transformées et nettoyées depuis l'API Yuman"
    columns:
      - name: demand_category_id
        description: "Identifiant unique de la catégorie de demande d'intervention"
        tests:
          - unique
          - not_null

  - name: stg_yuman__workorder_demands
    description: "Demande d'intervention transformés et nettoyés depuis l'API Yuman"
    columns:
      - name: demand_id
        description: "Identifiant unique de la demande d'intervention"
        tests:
          - unique
          - not_null
      - name: client_id
        description: "Référence vers le client propriétaire"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__clients')
                field: client_id
      - name: workorder_id
        description: "Référence vers l'intervention"
      - name: site_id
        description: "Référence vers le site propriétaire"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__sites')
                field: site_id
      - name: material_id
        description: "Référence vers la machine propriétaire"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__materials')
                field: material_id
      - name: user_id
        description: "Référence vers l'utilisateur qui a créé la demande"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__users')
                field: user_id
      - name: demand_category_id
        description: "Référence vers la catégorie de la demande"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__workorder_demands_categories')
                field: demand_category_id

  - name: stg_yuman__workorders
    description: "Interventions transformées et nettoyées depuis l'API Yuman"
    columns:
      - name: workorder_id
        description: "Identifiant unique de l'intervention"
        tests:
          - unique
          - not_null
      - name: client_id
        description: "Référence vers le client propriétaire"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__clients')
                field: client_id
      - name: site_id
        description: "Référence vers le site propriétaire"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__sites')
                field: site_id
      - name: category_id
        description: "Référence vers la catégorie de l'intervention"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__workorders_categories')
                field: category_id
      - name: workorder_number
        description: "Numéro de l'intervention"
      - name: contact_id
        description: "Référence vers le contact"
      - name: technician_id
        description: "Référence vers le technicien assigné"
      - name: manager_id
        description: "Référence vers le manager responsable"
      - name: workorder_type
        description: "Type de l'intervention YUMAN"
      - name: workorder_category  
        description: "Categorie intervention personnalisé EVS"
      - name: workorder_status
        description: "Statut de l'intervention"
      - name: workorder_title
        description: "Titre de l'intervention"
      - name: workorder_description
        description: "Description de l'intervention"
      - name: workorder_report
        description: "Rapport d'intervention"
      - name: workorder_technician_name
        description: "Nom du technicien assigné"
      - name: workorder_time_taken
        description: "Temps passé sur l'intervention"
      - name: workorder_date_creation
        description: "Date de création extraite des champs personnalisés"
      - name: workorder_motif_non_intervention
        description: "Motif de non intervention extrait des champs personnalisés"
      - name: workorder_detail_non_intervention
        description: "Détail du motif de non intervention extrait des champs personnalisés"
      - name: workorder_raison_mise_en_pause
        description: "Raison de mise en pause extraite des champs personnalisés"
      - name: workorder_explication_mise_en_pause
        description: "Explication de la mise en pause extraite des champs personnalisés"
      - name: workorder_necessite_intervenir
        description: "Nécessité d'intervenir extraite des champs personnalisés"
      - name: workorder_si_non_pourquoi
        description: "Explication si pas de nécessité d'intervenir extraite des champs personnalisés"
      - name: date_planned
        description: "Date de planification de l'intervention"
      - name: date_started
        description: "Date de début de l'intervention"
      - name: date_done
        description: "Date de fin de l'intervention"
      - name: created_at
        description: "Date de création de l'enregistrement"
        tests:
          - not_null
      - name: last_updated
        description: "Date de dernière mise à jour"
      - name: extracted_at
        description: "Date d'extraction depuis la source"
      - name: deleted_at
        description: "Date de suppression (soft delete)"

  - name: stg_yuman__purchase_orders
    description: "Purchase Orders dépliés : une ligne = une commande + une pièce associée"
    columns:
      # --- Identifiants clés ---
      - name: purchase_order_line_id
        description: "Identifiant unique de la ligne de commande"
        tests:
          - unique
          - not_null

      - name: purchase_order_id
        description: "Identifiant du bon de commande (entête)"
        tests:
          - not_null

      - name: product_id
        description: "Référence vers le produit commandé"
        tests:
          - relationships:
              arguments:
                to: ref('stg_yuman__products')   # ou ton modèle produit
                field: product_id

      - name: supplier_id
        description: "Référence vers le fournisseur (lié à un client ou supplier)"

      # --- Champs commande (entête) ---
      - name: purchase_order_number
        description: "Numéro du bon de commande"
      - name: purchase_order_satus
        description: "Statut de la commande"
      - name: purchase_order_invoice_status
        description: "Statut de facturation du bon de commande"
      - name: purchase_order_title
        description: "Titre du bon de commande"
      - name: order_description
        description: "Description du bon de commande"
      - name: creation_date
        description: "Date de création de la commande"
      - name: expected_delivery_date
        description: "Date de livraison attendue"
      - name: order_created_at
        description: "Date de création de l'enregistrement commande"
      - name: order_updated_at
        description: "Date de dernière mise à jour de la commande"
      - name: order_vat
        description: "Montant total de TVA de la commande"
      - name: order_subtotal
        description: "Sous-total de la commande"
      - name: order_total
        description: "Montant total TTC de la commande"
      - name: manager_id
        description: "Référence vers le manager de la commande"
      - name: quote_id
        description: "Référence vers le devis associé"
      - name: delivery_address
        description: "Adresse de livraison"

      # --- Champs ligne (items) ---
      - name: line_reference
        description: "Référence du produit dans la ligne"
      - name: line_description
        description: "Description de l'article de la ligne"
      - name: quantity
        description: "Quantité commandée"
      - name: unit
        description: "Unité de la ligne (ex: PIECE)"
      - name: quantity_received
        description: "Quantité effectivement reçue"
      - name: unit_price
        description: "Prix unitaire"
      - name: line_vat
        description: "TVA appliquée à la ligne"
      - name: line_subtotal
        description: "Sous-total HT de la ligne"
      - name: subtotal_received_eur
        description: "Sous-total reçu (converti en euros)"
      - name: subtotal_received_currency
        description: "Devise du sous-total reçu"
      - name: line_created_at
        description: "Date de création de la ligne"
      - name: line_updated_at
        description: "Date de dernière mise à jour de la ligne"

      # --- Métadonnées ---
      - name: extracted_at
        description: "Date d'extraction depuis la source (Singer/Meltano)"
      - name: sdc_sequence
        description: "Numéro de séquence pour suivi d'update via Meltano"

  # --- Table de faits dépliée des produits utilisés dans les interventions (workorders) ---
  - name: stg_yuman__workorder_products
    description: "Produits utilisés lors des interventions (workorders). 1 ligne = 1 produit utilisé dans une intervention. Cette table déplie le JSON _embed_products de la table yuman_workorders."
    columns:
      - name: workorder_product_id
        description: "Identifiant unique du produit utilisé dans l'intervention (clé primaire)"
        tests:
          - unique
          - not_null

      - name: workorder_id
        description: "Identifiant de l'intervention (clé étrangère vers stg_yuman__workorders)"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_yuman__workorders')
                field: workorder_id

      - name: product_id
        description: "Identifiant du produit (clé étrangère vers stg_yuman__products)"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_yuman__products')
                field: product_id

      - name: product_reference
        description: "Référence du produit (ex: EVS_NESPRESSO_0042605)"

      - name: product_designation
        description: "Désignation/nom du produit"

      - name: product_quantity
        description: "Quantité de produit utilisée lors de l'intervention"
        tests:
          - not_null

      - name: product_created_at
        description: "Date de création de l'association produit-workorder dans Yuman"

      - name: product_updated_at
        description: "Date de dernière mise à jour de l'association produit-workorder dans Yuman"

  - name: stg_yuman__storehouses
    description: "Storehouses clean depuis la table source yuman_storehouses"
    columns:
      - name: storehouses_id
        description: "Identifiant unique du storehouses (clé primaire)"
        tests:
          - unique
          - not_null