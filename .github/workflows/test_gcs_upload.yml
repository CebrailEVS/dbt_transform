name: Test GCS Upload

on:
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

jobs:
  test-gcs:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.DBT_BIGQUERY_KEYFILE }}

      - name: â˜ï¸ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: ğŸ” Debug - Check authenticated account
        run: gcloud auth list

      - name: ğŸ“ Create test manifest
        run: |
          mkdir -p target
          echo '{"test": "manifest", "timestamp": "'$(date)'"}'  > target/manifest.json
          cat target/manifest.json

      - name: ğŸ“¤ Upload test manifest to GCS (same path as CI/CD)
        run: |
          gsutil cp target/manifest.json gs://${{ secrets.DBT_STATE_BUCKET }}/dbt-state/manifest.json
          echo "âœ… Test manifest uploaded to dbt-state/manifest.json"

      - name: â¬‡ï¸ Download and verify
        run: |
          gsutil cat gs://${{ secrets.DBT_STATE_BUCKET }}/dbt-state/manifest.json
          echo "âœ… Test manifest verified from dbt-state/manifest.json"

      - name: ğŸ§¹ Cleanup - List files in dbt-state
        run: |
          echo "ğŸ“ Files in dbt-state folder:"
          gsutil ls gs://${{ secrets.DBT_STATE_BUCKET }}/dbt-state/